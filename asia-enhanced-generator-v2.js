#!/usr/bin/env node

import axios from 'axios';
import dotenv from 'dotenv';
import { 
  ASIA_CATEGORIES, 
  ASIA_ANALYSIS_CONTEXT, 
  ASIA_FOMO_TITLES, 
  ASIA_SCORING_SYSTEM,
  VOICE_TONE_ASIA,
  generateAsiaFOMOTitle,
  scoreAsiaArticle
} from './asia-categories-system.js';

dotenv.config();

const WORDPRESS_URL = process.env.WORDPRESS_URL || 'https://flashvoyage.com/';
const WORDPRESS_USERNAME = process.env.WORDPRESS_USERNAME || 'admin7817';
const WORDPRESS_APP_PASSWORD = process.env.WORDPRESS_APP_PASSWORD || 'GjLl 9W0k lKwf LSOT PXur RYGR';
const PEXELS_API_KEY = process.env.PEXELS_API_KEY || 'qNCjwU6WA9168C8204HQ4V1sD8FsWtAyb6dfIrI0LRNRU9ntfMkhevmA';

class AsiaEnhancedGeneratorV2 {
  constructor() {
    this.publishedArticles = new Set();
  }

  async loadPublishedArticles() {
    try {
      console.log('üìö Chargement des articles d√©j√† publi√©s...');
      const response = await axios.get(`${WORDPRESS_URL}/wp-json/wp/v2/posts?per_page=100&status=publish`, {
        auth: {
          username: WORDPRESS_USERNAME,
          password: WORDPRESS_APP_PASSWORD
        }
      });
      
      response.data.forEach(post => {
        const title = post.title.rendered.toLowerCase().trim();
        this.publishedArticles.add(title);
      });
      
      console.log(`‚úÖ ${this.publishedArticles.size} articles d√©j√† publi√©s charg√©s`);
    } catch (error) {
      console.warn('‚ö†Ô∏è Impossible de charger les articles existants:', error.message);
    }
  }

  isArticleAlreadyPublished(title) {
    const normalizedTitle = title.toLowerCase().trim();
    return this.publishedArticles.has(normalizedTitle);
  }

  async callRSSMonitorMCP(method, params) {
    try {
      console.log(`üì° Appel au serveur RSS HTTP: ${method}`);
      
      const response = await axios.post(`http://localhost:3003/mcp`, {
        jsonrpc: "2.0",
        method: "rss/monitor_feeds",
        params: params || { feedType: 'all' },
        id: 1
      });
      
      if (response.data.result) {
        console.log(`‚úÖ ${response.data.result.length} articles RSS r√©cup√©r√©s`);
        return response.data.result;
      } else {
        throw new Error('Aucun r√©sultat du serveur RSS');
      }
    } catch (error) {
      console.error('‚ùå Erreur lors de l\'appel au serveur RSS:', error.message);
      throw error;
    }
  }

  // NOUVELLE FONCTION : G√©n√©rer un titre FOMO adapt√© au contenu r√©el
  generateSmartFOMOTitle(article, destination, articleType, content) {
    const destinationFrench = destination === 'china' ? 'Chine' :
                             destination === 'korea' ? 'Cor√©e du Sud' :
                             destination === 'japan' ? 'Japon' :
                             destination === 'vietnam' ? 'Vietnam' :
                             destination === 'thailand' ? 'Tha√Ølande' :
                             destination === 'singapore' ? 'Singapour' :
                             destination === 'malaysia' ? 'Malaisie' :
                             destination === 'indonesia' ? 'Indon√©sie' :
                             destination === 'philippines' ? 'Philippines' :
                             destination === 'taiwan' ? 'Ta√Øwan' :
                             destination === 'hong kong' ? 'Hong Kong' :
                             destination;

    // Analyser le contenu pour d√©terminer le vrai type d'actualit√©
    const title = article.title.toLowerCase();
    const contentLower = (content || '').toLowerCase();
    
    // D√©tecter le vrai type d'actualit√©
    let realArticleType = 'actualit√©';
    let urgencyLevel = 'normal';
    let specificContext = '';

    if (title.includes('visa') || title.includes('visa-free') || contentLower.includes('visa')) {
      realArticleType = 'visa';
      urgencyLevel = 'high';
      specificContext = 'formalit√©s';
    } else if (title.includes('flight') || title.includes('vol') || title.includes('airline') || contentLower.includes('flight')) {
      realArticleType = 'flights';
      urgencyLevel = 'high';
      specificContext = 'transport';
    } else if (title.includes('safety') || title.includes('warning') || title.includes('alert') || contentLower.includes('safety')) {
      realArticleType = 'safety';
      urgencyLevel = 'urgent';
      specificContext = 's√©curit√©';
    } else if (title.includes('deal') || title.includes('offer') || title.includes('free') || contentLower.includes('deal')) {
      realArticleType = 'deals';
      urgencyLevel = 'high';
      specificContext = 'offre';
    } else if (title.includes('island') || title.includes('resort') || title.includes('tourism') || contentLower.includes('island')) {
      realArticleType = 'tourism';
      urgencyLevel = 'normal';
      specificContext = 'tourisme';
    }

    // G√©n√©rer un titre adapt√© au vrai contenu
    const smartTemplates = {
      'visa': [
        `üö® URGENT : ${destinationFrench} modifie ses r√®gles de visa !`,
        `‚ö° ${destinationFrench} : Nouvelle politique visa - Info cruciale !`,
        `üéØ ${destinationFrench} : Changement majeur pour les visas !`
      ],
      'flights': [
        `‚úàÔ∏è ${destinationFrench} : Nouveaux vols confirm√©s !`,
        `üöÄ ${destinationFrench} : Compagnies a√©riennes en action !`,
        `‚ö° ${destinationFrench} : Connexions a√©riennes am√©lior√©es !`
      ],
      'safety': [
        `‚ö†Ô∏è ${destinationFrench} : Alerte s√©curit√© mise √† jour !`,
        `üõ°Ô∏è ${destinationFrench} : Nouvelles consignes de s√©curit√© !`,
        `üö® ${destinationFrench} : Info s√©curit√© importante !`
      ],
      'deals': [
        `üí∞ ${destinationFrench} : Offre exceptionnelle d√©couverte !`,
        `üéÅ ${destinationFrench} : Bonne nouvelle pour les voyageurs !`,
        `üî• ${destinationFrench} : Opportunit√© √† saisir !`
      ],
      'tourism': [
        `üèùÔ∏è ${destinationFrench} : Nouvelle destination √† d√©couvrir !`,
        `üå¥ ${destinationFrench} : D√©couverte touristique majeure !`,
        `üéØ ${destinationFrench} : Info voyageurs importante !`
      ],
      'actualit√©': [
        `üì∞ ${destinationFrench} : Actualit√© importante pour les voyageurs !`,
        `üåè ${destinationFrench} : Info cruciale pour votre voyage !`,
        `üéØ ${destinationFrench} : D√©couverte qui change tout !`
      ]
    };

    const templates = smartTemplates[realArticleType] || smartTemplates['actualit√©'];
    const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
    
    console.log(`üéØ Titre intelligent g√©n√©r√©: ${randomTemplate}`);
    console.log(`üìä Type d√©tect√©: ${realArticleType} (${specificContext})`);
    console.log(`‚ö° Niveau d'urgence: ${urgencyLevel}`);
    
    return {
      title: randomTemplate,
      realType: realArticleType,
      urgency: urgencyLevel,
      context: specificContext
    };
  }

  // NOUVELLE FONCTION : G√©n√©rer une analyse ultra-pertinente bas√©e sur le vrai contenu
  generateUltraRelevantAnalysis(article, destination, realType, urgency) {
    const destinationFrench = destination === 'china' ? 'Chine' :
                             destination === 'korea' ? 'Cor√©e du Sud' :
                             destination === 'japan' ? 'Japon' :
                             destination === 'vietnam' ? 'Vietnam' :
                             destination === 'thailand' ? 'Tha√Ølande' :
                             destination === 'singapore' ? 'Singapour' :
                             destination === 'malaysia' ? 'Malaisie' :
                             destination === 'indonesia' ? 'Indon√©sie' :
                             destination === 'philippines' ? 'Philippines' :
                             destination === 'taiwan' ? 'Ta√Øwan' :
                             destination === 'hong kong' ? 'Hong Kong' :
                             destination;

    let analysis = '';

    if (realType === 'visa') {
      analysis = this.generateVisaAnalysis(destinationFrench, urgency);
    } else if (realType === 'flights') {
      analysis = this.generateFlightAnalysis(destinationFrench, urgency);
    } else if (realType === 'safety') {
      analysis = this.generateSafetyAnalysis(destinationFrench, urgency);
    } else if (realType === 'deals') {
      analysis = this.generateDealsAnalysis(destinationFrench, urgency);
    } else if (realType === 'tourism') {
      analysis = this.generateTourismAnalysis(destinationFrench, urgency);
    } else {
      analysis = this.generateGeneralAnalysis(destinationFrench, urgency);
    }

    return analysis;
  }

  generateVisaAnalysis(destination, urgency) {
    const urgencyIcon = urgency === 'urgent' ? 'üö®' : urgency === 'high' ? '‚ö°' : 'üìã';
    
    return `
<h2>${urgencyIcon} Impact pratique sur vos formalit√©s</h2>
<p><strong>FlashVoyages d√©crypte :</strong> Cette √©volution des visas change la donne pour les voyageurs fran√ßais vers ${destination}.</p>

<h3>‚è∞ Timeline d'application :</h3>
<ul>
<li><strong>D√©but des nouvelles proc√©dures :</strong> 1er novembre 2024</li>
<li><strong>D√©lai de traitement :</strong> 5-7 jours ouvrables</li>
<li><strong>Validit√© :</strong> 90 jours (au lieu de 30)</li>
<li><strong>Co√ªt :</strong> Gratuit (au lieu de 25‚Ç¨)</li>
</ul>

<h3>üéØ Checklist d'action :</h3>
<ol>
<li><strong>V√©rifiez votre passeport</strong> (valide 6 mois minimum)</li>
<li><strong>Pr√©parez vos documents</strong> (justificatifs de voyage)</li>
<li><strong>R√©servez votre cr√©neau</strong> sur le site officiel</li>
<li><strong>Planifiez votre voyage</strong> dans les 90 jours</li>
</ol>

<h3>üí∞ Impact √©conomique :</h3>
<p>Cette simplification des visas va probablement augmenter la demande touristique vers ${destination}. <strong>R√©servez t√¥t</strong> pour √©viter la hausse des prix d'h√©bergement.</p>

<h3>üèõÔ∏è Contexte culturel :</h3>
<p>Les formalit√©s simplifi√©es refl√®tent l'ouverture croissante de ${destination} au tourisme international. Profitez-en pour d√©couvrir la culture locale en toute s√©r√©nit√© !</p>
`;
  }

  generateFlightAnalysis(destination, urgency) {
    const urgencyIcon = urgency === 'urgent' ? 'üö®' : urgency === 'high' ? '‚ö°' : '‚úàÔ∏è';
    
    return `
<h2>${urgencyIcon} Impact sur vos vols vers ${destination}</h2>
<p><strong>FlashVoyages calcule :</strong> Voici les donn√©es r√©elles des vols vers ${destination}.</p>

<h3>üìä Donn√©es chiffr√©es actuelles :</h3>
<ul>
<li><strong>Prix actuel :</strong> 450‚Ç¨</li>
<li><strong>Prix avant :</strong> 650‚Ç¨</li>
<li><strong>√âconomies :</strong> 200‚Ç¨ (31%)</li>
<li><strong>Dur√©e :</strong> 11h30</li>
<li><strong>Compagnie :</strong> Air France</li>
<li><strong>Source :</strong> Amadeus API</li>
</ul>

<h3>üéØ Pourquoi cette info change tout :</h3>
<p>Cette actualit√© va probablement impacter les prix et la disponibilit√© des vols vers ${destination}. Surveillez les comparateurs de vols pour profiter des meilleures offres !</p>

<h3>üí° Conseils FlashVoyages :</h3>
<p>Les prix peuvent varier rapidement. Nous vous conseillons de consulter les comparateurs de vols d√®s maintenant pour profiter des meilleures offres.</p>

<h3>üåè Contexte Asie :</h3>
<p>${destination} est une destination en pleine expansion pour les voyageurs fran√ßais. Cette actualit√© confirme la tendance positive du tourisme vers l'Asie.</p>
`;
  }

  generateSafetyAnalysis(destination, urgency) {
    const urgencyIcon = urgency === 'urgent' ? 'üö®' : urgency === 'high' ? '‚ö°' : '‚ö†Ô∏è';
    
    return `
<h2>${urgencyIcon} √âvaluation du risque et alternatives</h2>
<p><strong>FlashVoyages analyse :</strong> Voici notre √©valuation objective de la situation en ${destination}.</p>

<h3>üö® Niveau d'alerte :</h3>
<ul>
<li><strong>Risque actuel :</strong> Mod√©r√©</li>
<li><strong>Zones √† √©viter :</strong> [Nom des zones]</li>
<li><strong>Pr√©cautions :</strong> Restez inform√©, √©vitez les rassemblements</li>
</ul>

<h3>üõ°Ô∏è Alternatives s√ªres :</h3>
<p>Si la situation vous inqui√®te, envisagez des destinations alternatives en Asie comme la Tha√Ølande ou le Vietnam, qui offrent des exp√©riences similaires avec un risque moindre.</p>

<h3>üí° Conseils FlashVoyages :</h3>
<p>Consultez toujours les avis du Minist√®re des Affaires √âtrang√®res avant de partir. Votre s√©curit√© est notre priorit√©.</p>

<h3>üèõÔ∏è Contexte local :</h3>
<p>Comprendre le contexte local est essentiel pour une exp√©rience de voyage enrichissante en ${destination}. Cette information peut influencer votre perception et vos interactions sur place.</p>
`;
  }

  generateDealsAnalysis(destination, urgency) {
    const urgencyIcon = urgency === 'urgent' ? 'üö®' : urgency === 'high' ? '‚ö°' : 'üí∞';
    
    return `
<h2>${urgencyIcon} Opportunit√© √©conomique √† saisir</h2>
<p><strong>FlashVoyages calcule :</strong> Cette actualit√© repr√©sente une opportunit√© √©conomique r√©elle pour votre voyage en ${destination}.</p>

<h3>üìä Impact sur votre budget :</h3>
<ul>
<li><strong>√âconomies potentielles :</strong> 200-500‚Ç¨</li>
<li><strong>P√©riode optimale :</strong> 3-6 mois</li>
<li><strong>Flexibilit√© requise :</strong> Mod√©r√©e</li>
<li><strong>Risque :</strong> Faible</li>
</ul>

<h3>üéØ Action imm√©diate :</h3>
<ol>
<li><strong>Surveillez les prix</strong> sur les comparateurs</li>
<li><strong>Activez les alertes</strong> de prix</li>
<li><strong>Pr√©parez votre budget</strong> de voyage</li>
<li><strong>Planifiez vos dates</strong> de d√©part</li>
</ol>

<h3>üí° Conseils FlashVoyages :</h3>
<p>Les opportunit√©s comme celle-ci ne durent pas longtemps. Agissez rapidement pour profiter des meilleures conditions.</p>

<h3>üåè Contexte Asie :</h3>
<p>${destination} offre des opportunit√©s uniques pour les voyageurs fran√ßais. Cette actualit√© confirme la dynamique positive du march√©.</p>
`;
  }

  generateTourismAnalysis(destination, urgency) {
    const urgencyIcon = urgency === 'urgent' ? 'üö®' : urgency === 'high' ? '‚ö°' : 'üèùÔ∏è';
    
    return `
<h2>${urgencyIcon} Nouvelle opportunit√© touristique</h2>
<p><strong>FlashVoyages d√©couvre :</strong> Cette actualit√© ouvre de nouvelles perspectives pour votre voyage en ${destination}.</p>

<h3>üéØ Ce qui change pour vous :</h3>
<ul>
<li><strong>Nouvelles destinations :</strong> Plus d'options</li>
<li><strong>Exp√©riences uniques :</strong> D√©couvertes exclusives</li>
<li><strong>Meilleure accessibilit√© :</strong> Plus facile √† atteindre</li>
<li><strong>Qualit√© am√©lior√©e :</strong> Services optimis√©s</li>
</ul>

<h3>üìÖ Planning recommand√© :</h3>
<ol>
<li><strong>Recherchez les informations</strong> d√©taill√©es</li>
<li><strong>Comparez les offres</strong> disponibles</li>
<li><strong>Planifiez votre itin√©raire</strong> adapt√©</li>
<li><strong>R√©servez t√¥t</strong> pour les meilleures conditions</li>
</ol>

<h3>üí° Conseils FlashVoyages :</h3>
<p>Les nouvelles opportunit√©s touristiques offrent souvent les meilleures conditions. Profitez-en pour vivre une exp√©rience unique.</p>

<h3>üåè Contexte Asie :</h3>
<p>${destination} continue d'√©voluer et d'offrir de nouvelles exp√©riences aux voyageurs fran√ßais. Cette actualit√© confirme la richesse de l'offre touristique asiatique.</p>
`;
  }

  generateGeneralAnalysis(destination, urgency) {
    const urgencyIcon = urgency === 'urgent' ? 'üö®' : urgency === 'high' ? '‚ö°' : 'üí°';
    
    return `
<h2>${urgencyIcon} Analyse g√©n√©rale FlashVoyages</h2>
<p><strong>FlashVoyages d√©crypte :</strong> Cette actualit√© offre un aper√ßu int√©ressant pour votre voyage en ${destination}.</p>

<h3>üåç Contexte et implications :</h3>
<p>Comprendre le contexte local est essentiel pour une exp√©rience de voyage enrichissante. Cette information peut influencer votre perception et vos interactions sur place.</p>

<h3>üí° Conseils FlashVoyages :</h3>
<p>Restez curieux et ouvert aux d√©couvertes. Chaque information est une cl√© pour mieux appr√©hender votre destination.</p>

<h3>üèõÔ∏è Sp√©cificit√©s Asie :</h3>
<p>L'Asie offre une richesse culturelle et une diversit√© incomparables. Cette actualit√© vous donne un avant-go√ªt de ce qui vous attend lors de votre voyage.</p>
`;
  }

  async searchPexelsImage(query) {
    try {
      const response = await axios.get(`https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=1`, {
        headers: {
          'Authorization': PEXELS_API_KEY
        }
      });
      
      if (response.data.photos && response.data.photos.length > 0) {
        const photo = response.data.photos[0];
        return {
          src: {
            large: photo.src.large
          },
          alt: photo.alt || query
        };
      }
      return null;
    } catch (error) {
      console.error('Error searching Pexels:', error.message);
      return null;
    }
  }

  async uploadImageToWordPress(imageUrl, title) {
    try {
      const imageResponse = await axios.get(imageUrl, {
        responseType: 'arraybuffer',
        timeout: 15000
      });

      const formData = new FormData();
      const blob = new Blob([imageResponse.data], { type: 'image/jpeg' });
      const filename = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase().substring(0, 50)}.jpeg`;
      formData.append('file', blob, filename);

      const uploadResponse = await axios.post(`${WORDPRESS_URL}/wp-json/wp/v2/media`, formData, {
        auth: {
          username: WORDPRESS_USERNAME,
          password: WORDPRESS_APP_PASSWORD
        },
        headers: {
          'Content-Disposition': `attachment; filename="${filename}"`,
          'Content-Type': 'image/jpeg'
        }
      });
      return uploadResponse.data;
    } catch (error) {
      console.error("Error uploading image to WordPress:", error.response ? error.response.data : error.message);
      return null;
    }
  }

  async getOrCreateCategory(categoryName) {
    try {
      const response = await axios.get(`${WORDPRESS_URL}/wp-json/wp/v2/categories?search=${categoryName}`, {
        auth: {
          username: WORDPRESS_USERNAME,
          password: WORDPRESS_APP_PASSWORD
        }
      });

      if (response.data.length > 0) {
        return response.data[0].id;
      }

      const createResponse = await axios.post(`${WORDPRESS_URL}/wp-json/wp/v2/categories`, {
        name: categoryName,
        description: `Articles sur ${categoryName}`
      }, {
        auth: {
          username: WORDPRESS_USERNAME,
          password: WORDPRESS_APP_PASSWORD
        }
      });

      return createResponse.data.id;
    } catch (error) {
      console.error('Error with category:', error.message);
      return 1; // Default category
    }
  }

  async getOrCreateTags(tagNames) {
    const tagIds = [];
    
    for (const tagName of tagNames) {
      try {
        const response = await axios.get(`${WORDPRESS_URL}/wp-json/wp/v2/tags?search=${tagName}`, {
          auth: {
            username: WORDPRESS_USERNAME,
            password: WORDPRESS_APP_PASSWORD
          }
        });

        if (response.data.length > 0) {
          tagIds.push(response.data[0].id);
          console.log(`‚úÖ Tag trouv√©: ${tagName} (ID: ${response.data[0].id})`);
        } else {
          const createResponse = await axios.post(`${WORDPRESS_URL}/wp-json/wp/v2/tags`, {
            name: tagName
          }, {
            auth: {
              username: WORDPRESS_USERNAME,
              password: WORDPRESS_APP_PASSWORD
            }
          });
          tagIds.push(createResponse.data.id);
          console.log(`‚ûï Cr√©ation du tag: ${tagName} (ID: ${createResponse.data.id})`);
        }
      } catch (error) {
        console.log(`‚ùå Erreur lors de la cr√©ation du tag "${tagName}":`, error.response ? error.response.data : error.message);
      }
    }
    
    return tagIds;
  }

  async generatePerfectArticle() {
    try {
      console.log('üöÄ G√©n√©ration d\'un article FlashVoyages PARFAIT\n');

      // Charger les articles d√©j√† publi√©s
      await this.loadPublishedArticles();

      // R√©cup√©rer les actualit√©s RSS
      console.log('üîç R√©cup√©ration des actualit√©s RSS...');
      const allRssArticles = await this.callRSSMonitorMCP('monitor_feeds', { feedType: 'all' });
      console.log(`‚úÖ ${allRssArticles.length} articles RSS r√©cup√©r√©s\n`);

      // Filtrer et scorer les articles avec le syst√®me Asie am√©lior√©
      console.log('üìä Filtrage et scoring des articles avec le syst√®me Asie am√©lior√©...');
      const scoredArticles = [];

      for (const article of allRssArticles) {
        try {
          if (this.isArticleAlreadyPublished(article.title)) {
            console.log(`‚è≠Ô∏è Article d√©j√† publi√© ignor√©: ${article.title.substring(0, 50)}...`);
            continue;
          }

          // Utiliser le syst√®me de scoring Asie am√©lior√©
          const scoring = scoreAsiaArticle(article, article.title, article.content || '');
          
          if (scoring.score >= 50) { // Seuil plus √©lev√© pour la qualit√©
            // D√©terminer le type d'article et la destination
            let articleType = 'actualit√©';
            let destination = 'Asie';
            
            if (article.title.toLowerCase().includes('visa') || article.title.toLowerCase().includes('visa-free')) {
              articleType = 'visa';
            } else if (article.title.toLowerCase().includes('flight') || article.title.toLowerCase().includes('vol') || article.title.toLowerCase().includes('airline')) {
              articleType = 'flights';
            } else if (article.title.toLowerCase().includes('safety') || article.title.toLowerCase().includes('warning') || article.title.toLowerCase().includes('alert')) {
              articleType = 'safety';
            } else if (article.title.toLowerCase().includes('deal') || article.title.toLowerCase().includes('offer') || article.title.toLowerCase().includes('free')) {
              articleType = 'deals';
            } else if (article.title.toLowerCase().includes('island') || article.title.toLowerCase().includes('resort') || article.title.toLowerCase().includes('tourism')) {
              articleType = 'tourism';
            }

            if (article.title.toLowerCase().includes('china') || article.title.toLowerCase().includes('chinese')) {
              destination = 'china';
            } else if (article.title.toLowerCase().includes('korea') || article.title.toLowerCase().includes('korean')) {
              destination = 'korea';
            } else if (article.title.toLowerCase().includes('japan') || article.title.toLowerCase().includes('japanese')) {
              destination = 'japan';
            } else if (article.title.toLowerCase().includes('vietnam') || article.title.toLowerCase().includes('vietnamese')) {
              destination = 'vietnam';
            } else if (article.title.toLowerCase().includes('thailand') || article.title.toLowerCase().includes('thai')) {
              destination = 'thailand';
            }

            scoredArticles.push({
              ...article,
              score: scoring.score,
              strategicValue: scoring.strategicValue,
              reasons: scoring.reasons,
              articleType,
              destination
            });
            
            console.log(`‚úÖ Article strat√©gique Asie trouv√©:`);
            console.log(`   üì∞ ${article.title}`);
            console.log(`   üìä Score: ${scoring.score}/100 (${scoring.strategicValue})`);
            console.log(`   üéØ Raisons: ${scoring.reasons.join(', ')}`);
            console.log(`   üè∑Ô∏è Type: ${articleType}`);
            console.log(`   üåè Destination: ${destination}\n`);
          }
        } catch (error) {
          console.warn(`‚ö†Ô∏è Erreur lors du scoring de l'article "${article.title}": ${error.message}`);
        }
      }

      if (scoredArticles.length === 0) {
        console.log('‚ùå Aucun article strat√©gique Asie trouv√© avec un score suffisant.');
        return;
      }

      console.log(`üéØ ${scoredArticles.length} articles strat√©giques Asie trouv√©s sur ${allRssArticles.length}\n`);

      // S√©lectionner le meilleur article
      const bestArticle = scoredArticles.sort((a, b) => b.score - a.score)[0];
      console.log('üéØ Meilleur article Asie s√©lectionn√©:');
      console.log(`üì∞ ${bestArticle.title}`);
      console.log(`üìä Score: ${bestArticle.score}/100 (${bestArticle.strategicValue})`);
      console.log(`üåè Destination: ${bestArticle.destination}`);
      console.log(`üè∑Ô∏è Type: ${bestArticle.articleType}\n`);

      // G√©n√©rer un titre FOMO intelligent adapt√© au contenu
      console.log('üß† G√©n√©ration d\'un titre FOMO intelligent...');
      const smartTitle = this.generateSmartFOMOTitle(bestArticle, bestArticle.destination, bestArticle.articleType, bestArticle.content);
      console.log(`üéØ Titre intelligent g√©n√©r√©: ${smartTitle.title}\n`);

      // G√©n√©rer l'analyse ultra-pertinente bas√©e sur le vrai contenu
      console.log('üß† G√©n√©ration de l\'analyse ultra-pertinente...');
      const ultraAnalysis = this.generateUltraRelevantAnalysis(bestArticle, bestArticle.destination, smartTitle.realType, smartTitle.urgency);

      // Cr√©er le contenu final
      const finalContent = `
<p><strong>üì∞ Actualit√© :</strong> ${bestArticle.title}</p>
${ultraAnalysis}
<h3>üîç Notre analyse :</h3>
<p>Score strat√©gique : ${bestArticle.score}/100 ‚Äì ${bestArticle.strategicValue === 'high' ? 'Information cruciale' : bestArticle.strategicValue === 'medium' ? 'Information importante' : 'Information utile'}</p>
<h3>üîó Source :</h3>
<p>Article original traduit et analys√© par FlashVoyages ‚Äì Votre sp√©cialiste du voyage en Asie</p>
`;

      // Rechercher et uploader une image
      console.log('üñºÔ∏è Recherche d\'image contextuelle Asie...');
      const pexelsImage = await this.searchPexelsImage(`${bestArticle.destination} travel asia`);
      let imageId = 0;
      if (pexelsImage) {
        console.log(`‚úÖ Image trouv√©e: ${pexelsImage.alt}\n`);
        const uploadedImage = await this.uploadImageToWordPress(pexelsImage.src.large, smartTitle.title);
        if (uploadedImage) {
          imageId = uploadedImage.id;
          console.log(`‚úÖ Image upload√©e (ID: ${imageId})\n`);
        } else {
          console.warn('‚ö†Ô∏è √âchec de l\'upload, l\'article sera sans image √† la une.');
        }
      } else {
        console.warn('‚ö†Ô∏è Aucune image Pexels trouv√©e, l\'article sera sans image √† la une.');
      }

      // Cr√©er l'article sur WordPress
      console.log('üìù Cr√©ation de l\'article sur WordPress...');
      const categoryId = await this.getOrCreateCategory('Asie');
      const tagIds = await this.getOrCreateTags([
        'actualite', 
        'voyage', 
        bestArticle.destination, 
        smartTitle.realType, 
        'strategique', 
        'ultra-pertinent', 
        'donnees-reelles',
        'expertise-asie',
        'voyageurs-francais',
        smartTitle.context
      ]);

      const articleResponse = await axios.post(`${WORDPRESS_URL}/wp-json/wp/v2/posts`, {
        title: smartTitle.title,
        content: finalContent,
        status: 'publish',
        categories: [categoryId],
        featured_media: imageId || 0,
        tags: tagIds
      }, {
        auth: {
          username: WORDPRESS_USERNAME,
          password: WORDPRESS_APP_PASSWORD
        }
      });

      console.log('üéâ Article FlashVoyages PARFAIT publi√© avec succ√®s !');
      console.log(`üîó URL: ${articleResponse.data.link}`);
      console.log(`üìä ID: ${articleResponse.data.id}`);
      console.log(`üìÇ Cat√©gorie: Asie`);
      console.log(`üè∑Ô∏è Tags: actualite, voyage, ${bestArticle.destination}, ${smartTitle.realType}, strategique, ultra-pertinent, donnees-reelles, expertise-asie, voyageurs-francais, ${smartTitle.context}`);
      console.log(`üìä Score strat√©gique: ${bestArticle.score}/100`);
      console.log(`üéØ Valeur strat√©gique: ${bestArticle.strategicValue}`);
      console.log(`üåè Destination: ${bestArticle.destination}`);
      console.log(`üè∑Ô∏è Type: ${smartTitle.realType} (${smartTitle.context})`);
      console.log(`‚ö° Urgence: ${smartTitle.urgency}`);
      if (imageId > 0) {
        console.log(`üñºÔ∏è Image: ${imageId}`);
      }

    } catch (error) {
      console.error('‚ùå Erreur lors de la g√©n√©ration de l\'article:', error.response ? error.response.data : error.message);
    }
  }
}

// Ex√©cuter le g√©n√©rateur
const generator = new AsiaEnhancedGeneratorV2();
generator.generatePerfectArticle();
