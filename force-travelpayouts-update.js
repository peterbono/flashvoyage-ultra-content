#!/usr/bin/env node

import axios from 'axios';
import { WORDPRESS_URL, WORDPRESS_USERNAME, WORDPRESS_APP_PASSWORD } from './config.js';

class TravelpayoutsForceUpdater {
  constructor() {
    this.wordpressUrl = WORDPRESS_URL;
    this.username = WORDPRESS_USERNAME;
    this.password = WORDPRESS_APP_PASSWORD;
    this.partnerId = '463418';
  }

  // Cr√©er un contenu compl√®tement nouveau avec les widgets
  createNewContentWithWidgets() {
    console.log(`üîß Cr√©ation d'un contenu compl√®tement nouveau avec Partner ID: ${this.partnerId}...`);

    const newContent = `
<p><strong>Source :</strong> <a href="https://reddit.com/r/digitalnomad/comments/example">Comment j'ai doubl√© mes revenus en 6 mois en Tha√Ølande</a> ‚Äì Reddit</p>

<h2>Comment Paul a doubl√© ses revenus en Tha√Ølande : une transformation compl√®te</h2>

<p><strong>Introduction (60-80 mots) :</strong></p>
<p>Je suis Paul, 29 ans, d√©veloppeur freelance. Il y a 8 mois, j'ai d√©cid√© de changer compl√®tement de mode de vie et devenir nomade digital en Tha√Ølande. Aujourd'hui, je gagne 2x plus qu'avant et j'ai trouv√© l'√©quilibre parfait et je veux partager mon parcours pour inspirer d'autres nomades.</p>

<h3>Le d√©fi initial</h3>
<p><strong>Situation de d√©part (100-120 mots) :</strong></p>
<p>J'√©tais dans une situation difficile avec des revenus instables et un manque de direction claire dans ma carri√®re de nomade.</p>
<p><strong>Objectifs fix√©s :</strong> Stabiliser mes revenus, am√©liorer ma productivit√©, et cr√©er un r√©seau professionnel solide</p>
<p><strong>Obstacles identifi√©s :</strong> Manque de structure, isolement professionnel, et difficult√©s de concentration</p>

<h3>Ma strat√©gie d'action</h3>
<p><strong>Plan mis en place (120-150 mots) :</strong></p>
<p>Pour atteindre mes objectifs, j'ai d'abord cr√©√© un r√©seau local solide. J'ai ensuite optimis√© ma productivit√© avec des outils adapt√©s et trouv√© des clients qui paient mieux.</p>
<p>J'ai utilis√© Notion pour organiser mes t√¢ches pour g√©rer mes projets efficacement et LinkedIn pour d√©velopper mon r√©seau pour trouver de nouveaux clients. Ces outils m'ont permis de doubler ma productivit√© et tripler mes revenus.</p>
<p>Ma routine quotidienne incluait 2h de prospection matinale, 4h de travail concentr√© et 1h de networking le soir.</p>

<h3>Les r√©sultats obtenus</h3>
<p><strong>Succ√®s concrets (100-120 mots) :</strong></p>
<p>Apr√®s 6 mois d'efforts constants, j'ai atteint doubl√© mes revenus mensuels, cr√©√© un r√©seau de 50+ contacts professionnels et trouv√© l'√©quilibre vie/travail parfait.</p>
<p><strong>B√©n√©fices mesurables :</strong> Revenus pass√©s de 2000‚Ç¨ √† 4000‚Ç¨/mois, 15 nouveaux clients r√©guliers</p>
<p><strong>Impact sur ma vie :</strong> Je me sens √©panoui, libre et motiv√© comme jamais</p>

<h3>Mes conseils pour r√©ussir</h3>
<p><strong>Strat√©gies gagnantes (3-5 points) :</strong></p>
<ul>
<li><strong>Commencez par cr√©er un r√©seau local :</strong> Les connexions locales sont essentielles pour trouver des opportunit√©s</li>
<li><strong>Investissez dans des outils de productivit√© :</strong> Notion, Trello et Calendly m'ont fait gagner 3h par jour</li>
<li><strong>R√©seauz avec d'autres nomades exp√©riment√©s :</strong> Leurs conseils m'ont √©vit√© de nombreuses erreurs co√ªteuses</li>
<li><strong>Pers√©v√©rez malgr√© les moments difficiles :</strong> Les 3 premiers mois sont les plus durs, mais √ßa vaut le coup</li>
<li><strong>C√©l√©brez chaque petite victoire :</strong> C√©l√©brer les succ√®s motive √† continuer et √† s'am√©liorer</li>
</ul>

<h3>Outils qui m'ont aid√©</h3>
<p><strong>Ressources recommand√©es :</strong></p>

<div class="travelpayouts-widget flights-widget" style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
  <h4 style="color: #2c3e50; margin-bottom: 15px;">‚úàÔ∏è Trouvez les meilleurs vols vers l'Asie</h4>
  <div class="tp-widget-container">
    <script async src="https://www.travelpayouts.com/calendar_widget/calendar_widget.js?currency=eur&marker=${this.partnerId}&search_host=jetradar.com&locale=fr&powered_by=false&destination=BKK&destination_name=Bangkok" charset="utf-8"></script>
  </div>
</div>

<div class="travelpayouts-widget hotels-widget" style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
  <h4 style="color: #2c3e50; margin-bottom: 15px;">üè® R√©servez votre h√©bergement en Asie</h4>
  <div class="tp-widget-container">
    <script async src="https://www.travelpayouts.com/hotels_widget/hotels_widget.js?currency=eur&marker=${this.partnerId}&search_host=hotellook.com&locale=fr&powered_by=false&destination=BKK&destination_name=Bangkok" charset="utf-8"></script>
  </div>
</div>

<div class="travelpayouts-widget insurance-widget" style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
  <h4 style="color: #2c3e50; margin-bottom: 15px;">üõ°Ô∏è Assurance voyage pour nomades</h4>
  <div class="tp-widget-container">
    <a href="https://www.travelpayouts.com/redirect?marker=${this.partnerId}&url=https://www.worldnomads.com" target="_blank" rel="nofollow" style="display: block; text-align: center; padding: 10px; background: #3498db; color: white; text-decoration: none; border-radius: 5px;">
      <strong>üõ°Ô∏è Assurance voyage World Nomads</strong><br>
      <small>Protection compl√®te pour nomades digitaux</small>
    </a>
  </div>
</div>

<div class="travelpayouts-widget productivity-widget" style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
  <h4 style="color: #2c3e50; margin-bottom: 15px;">üíº Outils essentiels pour nomades</h4>
  <div class="tp-widget-container">
    <ul style="list-style: none; padding: 0; margin: 0;">
      <li style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #3498db;">
        <a href="https://www.travelpayouts.com/redirect?marker=${this.partnerId}&url=https://notion.so" target="_blank" rel="nofollow" style="text-decoration: none; color: #2c3e50;">
          <strong>üìù Notion</strong> - Organisation et productivit√©
        </a>
      </li>
      <li style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #e74c3c;">
        <a href="https://www.travelpayouts.com/redirect?marker=${this.partnerId}&url=https://trello.com" target="_blank" rel="nofollow" style="text-decoration: none; color: #2c3e50;">
          <strong>üìã Trello</strong> - Gestion de projets
        </a>
      </li>
      <li style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px; border-left: 4px solid #f39c12;">
        <a href="https://www.travelpayouts.com/redirect?marker=${this.partnerId}&url=https://calendly.com" target="_blank" rel="nofollow" style="text-decoration: none; color: #2c3e50;">
          <strong>üìÖ Calendly</strong> - Planification de rendez-vous
        </a>
      </li>
    </ul>
  </div>
</div>

<h3>Articles connexes</h3>
<p><strong>Liens internes :</strong></p>
<ul>
<li><a href="#">Guide connexe</a> ‚Äì Article compl√©mentaire</li>
<li><a href="#">Ressource utile</a> ‚Äì Information suppl√©mentaire</li>
</ul>

<p><em>Cet article a √©t√© analys√© par notre √©quipe FlashVoyages ‚Äî votre sp√©cialiste du nomadisme en Asie.</em></p>`;

    console.log('‚úÖ Contenu compl√®tement nouveau cr√©√© avec widgets int√©gr√©s');
    return newContent;
  }

  // Forcer la mise √† jour de l'article
  async forceUpdateArticle(articleId, newContent) {
    try {
      console.log(`üìù Mise √† jour forc√©e de l'article ${articleId}...`);

      const updateResponse = await axios.post(`${this.wordpressUrl}/wp-json/wp/v2/posts/${articleId}`, {
        content: newContent
      }, {
        auth: {
          username: this.username,
          password: this.password
        },
        headers: {
          'Content-Type': 'application/json'
        }
      });

      console.log('‚úÖ Article mis √† jour avec force!');
      console.log(`üîó Lien: ${updateResponse.data.link}`);

      return updateResponse.data;

    } catch (error) {
      console.error('‚ùå Erreur mise √† jour forc√©e:', error.response?.data || error.message);
      throw error;
    }
  }

  // V√©rifier l'int√©gration finale
  async verifyFinalIntegration(articleUrl) {
    try {
      console.log('üîç V√©rification de l\'int√©gration finale...');
      
      const response = await axios.get(articleUrl);
      const html = response.data;
      
      const checks = {
        hasPartnerId: html.includes(`marker=${this.partnerId}`),
        hasFlightsScript: html.includes('travelpayouts.com/calendar_widget') && html.includes(`marker=${this.partnerId}`),
        hasHotelsScript: html.includes('travelpayouts.com/hotels_widget') && html.includes(`marker=${this.partnerId}`),
        hasInsuranceLink: html.includes('worldnomads.com') && html.includes(`marker=${this.partnerId}`),
        hasProductivityLinks: html.includes('notion.so') && html.includes(`marker=${this.partnerId}`),
        hasTrackingLinks: html.includes('travelpayouts.com/redirect') && html.includes(`marker=${this.partnerId}`),
        hasStyling: html.includes('style=') && html.includes('border-radius'),
        noPlaceholders: !html.includes('{{TRAVELPAYOUTS_') && !html.includes('TRAVELPAYOUTS_'),
        noOldMarker: !html.includes('marker=123456')
      };

      const score = Object.values(checks).filter(Boolean).length;
      const total = Object.keys(checks).length;
      const percentage = Math.round((score / total) * 100);

      console.log('üìä R√©sultats de v√©rification finale:');
      console.log(`‚úÖ Partner ID ${this.partnerId}: ${checks.hasPartnerId ? 'OUI' : 'NON'}`);
      console.log(`‚úÖ Script vols avec tracking: ${checks.hasFlightsScript ? 'OUI' : 'NON'}`);
      console.log(`‚úÖ Script h√¥tels avec tracking: ${checks.hasHotelsScript ? 'OUI' : 'NON'}`);
      console.log(`‚úÖ Lien assurance avec tracking: ${checks.hasInsuranceLink ? 'OUI' : 'NON'}`);
      console.log(`‚úÖ Liens productivit√© avec tracking: ${checks.hasProductivityLinks ? 'OUI' : 'NON'}`);
      console.log(`‚úÖ Liens de tracking: ${checks.hasTrackingLinks ? 'OUI' : 'NON'}`);
      console.log(`‚úÖ Styling appliqu√©: ${checks.hasStyling ? 'OUI' : 'NON'}`);
      console.log(`‚úÖ Plus de placeholders: ${checks.noPlaceholders ? 'OUI' : 'NON'}`);
      console.log(`‚úÖ Ancien marker supprim√©: ${checks.noOldMarker ? 'OUI' : 'NON'}`);
      console.log(`üìà Score d'int√©gration: ${percentage}%`);

      return {
        score: percentage,
        checks: checks,
        isPerfect: percentage >= 90
      };

    } catch (error) {
      console.error('‚ùå Erreur v√©rification finale:', error.message);
      throw error;
    }
  }

  // Processus complet de mise √† jour forc√©e
  async forceUpdateCompletely() {
    try {
      console.log('üîß MISE √Ä JOUR FORC√âE COMPL√àTE\n');

      // 1. Cr√©er un contenu compl√®tement nouveau
      console.log(`√âTAPE 1: Cr√©ation d'un contenu compl√®tement nouveau avec Partner ID ${this.partnerId}...`);
      const newContent = this.createNewContentWithWidgets();

      // 2. Forcer la mise √† jour
      console.log('\n√âTAPE 2: Mise √† jour forc√©e de l\'article...');
      const updatedArticle = await this.forceUpdateArticle(879, newContent);

      // 3. V√©rifier l'int√©gration finale
      console.log('\n√âTAPE 3: V√©rification de l\'int√©gration finale...');
      const verification = await this.verifyFinalIntegration(updatedArticle.link);

      // 4. R√©sultat final
      console.log('\nüéØ R√âSULTAT FINAL:');
      if (verification.isPerfect) {
        console.log('‚úÖ SUCC√àS TOTAL! Widgets Travelpayouts parfaitement int√©gr√©s');
        console.log(`üìà Score d'int√©gration: ${verification.score}%`);
        console.log(`üîó Lien: ${updatedArticle.link}`);
        console.log(`üí∞ Tracking activ√© avec Partner ID: ${this.partnerId}`);
        console.log('üéâ Pr√™t √† g√©n√©rer des revenus d\'affiliation!');
      } else {
        console.log('‚ùå √âCHEC! Widgets non parfaitement int√©gr√©s');
        console.log(`üìà Score d'int√©gration: ${verification.score}%`);
        console.log('üîß Corrections suppl√©mentaires n√©cessaires...');
      }

      return {
        success: verification.isPerfect,
        score: verification.score,
        articleUrl: updatedArticle.link,
        partnerId: this.partnerId,
        verification: verification
      };

    } catch (error) {
      console.error('‚ùå Erreur mise √† jour forc√©e:', error.message);
      throw error;
    }
  }
}

async function forceUpdateCompletely() {
  const updater = new TravelpayoutsForceUpdater();
  
  try {
    const result = await updater.forceUpdateCompletely();
    
    if (result.success) {
      console.log('\nüèÜ WIDGETS TRAVELPAYOUTS PARFAITS!');
      console.log(`‚úÖ Tracking activ√© avec Partner ID: ${result.partnerId}`);
      console.log('üí∞ Pr√™t √† g√©n√©rer des revenus d\'affiliation!');
      console.log(`üîó V√©rifiez: ${result.articleUrl}`);
    } else {
      console.log('\n‚ö†Ô∏è CORRECTIONS N√âCESSAIRES');
      console.log('üîß Les widgets n√©cessitent encore des ajustements');
    }

  } catch (error) {
    console.error('‚ùå Erreur critique:', error.message);
  }
}

forceUpdateCompletely();
