#!/usr/bin/env node

import axios from 'axios';
import { WORDPRESS_URL, WORDPRESS_USERNAME, WORDPRESS_APP_PASSWORD, PEXELS_API_KEY } from './config.js';

class FeaturedImageSetter {
  constructor() {
    this.wordpressUrl = WORDPRESS_URL;
    this.username = WORDPRESS_USERNAME;
    this.password = WORDPRESS_APP_PASSWORD;
    this.pexelsApiKey = PEXELS_API_KEY;
  }

  // Rechercher une image appropri√©e pour Paul
  async searchFeaturedImage() {
    try {
      console.log('üîç Recherche d\'une image featured appropri√©e pour Paul...');
      
      const response = await axios.get('https://api.pexels.com/v1/search', {
        headers: {
          'Authorization': this.pexelsApiKey
        },
        params: {
          query: 'man laptop digital nomad thailand',
          per_page: 5,
          orientation: 'landscape'
        }
      });

      const images = response.data.photos.map(photo => ({
        id: photo.id,
        url: photo.src.large,
        photographer: photo.photographer,
        photographer_url: photo.photographer_url,
        alt: photo.alt || 'Digital nomad man with laptop',
        width: photo.width,
        height: photo.height
      }));

      console.log(`‚úÖ ${images.length} images trouv√©es`);
      return images;

    } catch (error) {
      console.error('‚ùå Erreur recherche image:', error.response?.data || error.message);
      return [];
    }
  }

  // S√©lectionner la meilleure image pour featured
  selectBestFeaturedImage(images) {
    if (!images || images.length === 0) return null;

    let bestImage = images[0];
    let bestScore = 0;

    images.forEach(image => {
      let score = 0;
      const altLower = image.alt.toLowerCase();
      
      // Mots-cl√©s prioritaires
      const keywords = ['man', 'male', 'laptop', 'digital', 'nomad', 'thailand', 'working', 'business'];
      
      keywords.forEach(keyword => {
        if (altLower.includes(keyword)) {
          score += 1;
        }
      });
      
      // Bonus pour les images d'hommes
      if (altLower.includes('man') || altLower.includes('male')) {
        score += 2;
      }
      
      // Bonus pour les images de travail
      if (altLower.includes('laptop') || altLower.includes('working')) {
        score += 1;
      }
      
      if (score > bestScore) {
        bestScore = score;
        bestImage = image;
      }
    });

    console.log(`‚úÖ Meilleure image featured s√©lectionn√©e: "${bestImage.alt}" (score: ${bestScore})`);
    return bestImage;
  }

  // T√©l√©charger l'image et l'uploader sur WordPress
  async uploadImageToWordPress(image) {
    try {
      console.log(`üì§ Upload de l'image "${image.alt}" sur WordPress...`);

      // T√©l√©charger l'image depuis Pexels
      const imageResponse = await axios.get(image.url, {
        responseType: 'arraybuffer'
      });

      // Cr√©er un FormData pour l'upload
      const { FormData } = await import('form-data');
      const form = new FormData();
      
      form.append('file', imageResponse.data, {
        filename: `paul-nomade-digital-${image.id}.jpg`,
        contentType: 'image/jpeg'
      });

      // Uploader l'image sur WordPress
      const uploadResponse = await axios.post(`${this.wordpressUrl}/wp-json/wp/v2/media`, form, {
        auth: {
          username: this.username,
          password: this.password
        },
        headers: {
          ...form.getHeaders(),
          'Content-Disposition': `attachment; filename="paul-nomade-digital-${image.id}.jpg"`
        }
      });

      console.log('‚úÖ Image upload√©e sur WordPress avec succ√®s!');
      console.log(`üì∏ ID WordPress: ${uploadResponse.data.id}`);
      console.log(`üîó URL: ${uploadResponse.data.source_url}`);

      return uploadResponse.data;

    } catch (error) {
      console.error('‚ùå Erreur upload image:', error.response?.data || error.message);
      throw error;
    }
  }

  // D√©finir l'image comme featured image
  async setFeaturedImage(articleId, imageId) {
    try {
      console.log(`üì∏ D√©finition de l'image ${imageId} comme featured image...`);

      const updateResponse = await axios.post(`${this.wordpressUrl}/wp-json/wp/v2/posts/${articleId}`, {
        featured_media: imageId
      }, {
        auth: {
          username: this.username,
          password: this.password
        },
        headers: {
          'Content-Type': 'application/json'
        }
      });

      console.log('‚úÖ Featured image d√©finie avec succ√®s!');
      console.log(`üîó Lien: ${updateResponse.data.link}`);

      return updateResponse.data;

    } catch (error) {
      console.error('‚ùå Erreur d√©finition featured image:', error.response?.data || error.message);
      throw error;
    }
  }

  // Supprimer l'image du corps de l'article
  async removeImageFromContent(articleId) {
    try {
      console.log(`üßπ Suppression de l'image du corps de l'article ${articleId}...`);

      // R√©cup√©rer l'article actuel
      const getResponse = await axios.get(`${this.wordpressUrl}/wp-json/wp/v2/posts/${articleId}`, {
        auth: {
          username: this.username,
          password: this.password
        }
      });

      const article = getResponse.data;
      let content = article.content.rendered;

      // Supprimer l'ancienne image du corps
      content = content.replace(
        /<div class="article-featured-image"[\s\S]*?<\/div>/g,
        ''
      );

      // Mettre √† jour l'article
      const updateResponse = await axios.post(`${this.wordpressUrl}/wp-json/wp/v2/posts/${articleId}`, {
        content: content
      }, {
        auth: {
          username: this.username,
          password: this.password
        },
        headers: {
          'Content-Type': 'application/json'
        }
      });

      console.log('‚úÖ Image supprim√©e du corps de l\'article!');
      return updateResponse.data;

    } catch (error) {
      console.error('‚ùå Erreur suppression image:', error.response?.data || error.message);
      throw error;
    }
  }

  // V√©rifier que la featured image est bien d√©finie
  async verifyFeaturedImage(articleUrl) {
    try {
      console.log('üîç V√©rification de la featured image...');
      
      const response = await axios.get(articleUrl);
      const html = response.data;
      
      const checks = {
        hasFeaturedImage: html.includes('wp-post-image') || html.includes('featured-image'),
        hasImageInContent: !html.includes('article-featured-image'),
        hasImageTag: html.includes('<img'),
        hasPexelsImage: html.includes('pexels.com'),
        hasMaleKeywords: html.includes('man') || html.includes('male') || html.includes('businessman')
      };

      const score = Object.values(checks).filter(Boolean).length;
      const total = Object.keys(checks).length;
      const percentage = Math.round((score / total) * 100);

      console.log('üìä R√©sultats de v√©rification:');
      console.log(`‚úÖ Featured image: ${checks.hasFeaturedImage ? 'OUI' : 'NON'}`);
      console.log(`‚úÖ Pas d'image dans le contenu: ${checks.hasImageInContent ? 'OUI' : 'NON'}`);
      console.log(`‚úÖ Tag img pr√©sent: ${checks.hasImageTag ? 'OUI' : 'NON'}`);
      console.log(`‚úÖ Image Pexels: ${checks.hasPexelsImage ? 'OUI' : 'NON'}`);
      console.log(`‚úÖ Mots-cl√©s masculins: ${checks.hasMaleKeywords ? 'OUI' : 'NON'}`);
      console.log(`üìà Score de conformit√©: ${percentage}%`);

      return {
        score: percentage,
        checks: checks,
        isCorrect: percentage >= 80
      };

    } catch (error) {
      console.error('‚ùå Erreur v√©rification:', error.message);
      throw error;
    }
  }

  // Processus complet de d√©finition de featured image
  async setFeaturedImageCompletely() {
    try {
      console.log('üì∏ D√âFINITION DE LA FEATURED IMAGE\n');

      // 1. Rechercher une image appropri√©e
      console.log('√âTAPE 1: Recherche d\'une image appropri√©e...');
      const images = await this.searchFeaturedImage();

      if (images.length === 0) {
        console.log('‚ùå Aucune image trouv√©e');
        return null;
      }

      // 2. S√©lectionner la meilleure image
      console.log('\n√âTAPE 2: S√©lection de la meilleure image...');
      const bestImage = this.selectBestFeaturedImage(images);

      if (!bestImage) {
        console.log('‚ùå Aucune image appropri√©e trouv√©e');
        return null;
      }

      // 3. Uploader l'image sur WordPress
      console.log('\n√âTAPE 3: Upload de l\'image sur WordPress...');
      const uploadedImage = await this.uploadImageToWordPress(bestImage);

      // 4. Supprimer l'ancienne image du contenu
      console.log('\n√âTAPE 4: Suppression de l\'ancienne image du contenu...');
      await this.removeImageFromContent(879);

      // 5. D√©finir comme featured image
      console.log('\n√âTAPE 5: D√©finition comme featured image...');
      const updatedArticle = await this.setFeaturedImage(879, uploadedImage.id);

      // 6. V√©rifier
      console.log('\n√âTAPE 6: V√©rification...');
      const verification = await this.verifyFeaturedImage(updatedArticle.link);

      // 7. R√©sultat final
      console.log('\nüéØ R√âSULTAT FINAL:');
      if (verification.isCorrect) {
        console.log('‚úÖ SUCC√àS! Featured image d√©finie correctement');
        console.log(`üìà Score de conformit√©: ${verification.score}%`);
        console.log(`üì∏ Image: "${bestImage.alt}"`);
        console.log(`üë§ Photographe: ${bestImage.photographer}`);
        console.log(`üîó Lien: ${updatedArticle.link}`);
      } else {
        console.log('‚ùå √âCHEC! Featured image pas correctement d√©finie');
        console.log(`üìà Score de conformit√©: ${verification.score}%`);
      }

      return {
        success: verification.isCorrect,
        score: verification.score,
        image: bestImage,
        articleUrl: updatedArticle.link
      };

    } catch (error) {
      console.error('‚ùå Erreur d√©finition featured image:', error.message);
      throw error;
    }
  }
}

async function setFeaturedImageCompletely() {
  const setter = new FeaturedImageSetter();
  
  try {
    const result = await setter.setFeaturedImageCompletely();
    
    if (result && result.success) {
      console.log('\nüèÜ FEATURED IMAGE D√âFINIE!');
      console.log('‚úÖ Image mise en avant correctement d√©finie');
      console.log(`üîó V√©rifiez: ${result.articleUrl}`);
    } else {
      console.log('\n‚ö†Ô∏è PROBL√àME AVEC LA FEATURED IMAGE');
      console.log('üîß La featured image n\'est pas correctement d√©finie');
    }

  } catch (error) {
    console.error('‚ùå Erreur critique:', error.message);
  }
}

setFeaturedImageCompletely();
