#!/usr/bin/env node

import axios from 'axios';
import xml2js from 'xml2js';
import dotenv from 'dotenv';

dotenv.config();

class UltraSmartRSSFilter {
  constructor() {
    // Sources RSS sp√©cialis√©es Asie en fran√ßais
    this.asiaRSSSources = {
      'french_travel_asia': [
        'https://www.routard.com/rss/actualites.xml',
        'https://www.lefigaro.fr/rss/figaro_voyage.xml',
        'https://www.lexpress.fr/rss/voyage.xml'
      ],
      'asia_news_french': [
        'https://www.rfi.fr/fr/rss/asie-pacifique.xml',
        'https://www.lemonde.fr/rss/sequence/ASIE.xml',
        'https://www.france24.com/fr/rss/category/asie-pacifique'
      ],
      'travel_deals_asia': [
        'https://www.voyage-prive.com/rss',
        'https://www.lastminute.com/rss/fr/offres-voyage.xml'
      ]
    };

    // Mots-cl√©s de pertinence Asie (fran√ßais)
    this.asiaKeywords = {
      'destinations': [
        'japon', 'tokyo', 'kyoto', 'osaka', 'japonais', 'nippon',
        'thailande', 'bangkok', 'phuket', 'chiang mai', 'tha√Ølandais',
        'cor√©e', 's√©oul', 'busan', 'cor√©en', 'cor√©enne',
        'vietnam', 'hanoi', 'ho chi minh', 'h√¥ chi minh', 'vietnamien',
        'singapour', 'singapourien', 'malaisie', 'kuala lumpur',
        'philippines', 'manille', 'cebu', 'philippin',
        'indon√©sie', 'jakarta', 'bali', 'indon√©sien',
        'chine', 'p√©kin', 'shanghai', 'hong kong', 'chinois',
        'taiwan', 'ta√Øwan', 'ta√Øpei', 'ta√Øwanais',
        'cambodge', 'phnom penh', 'angkor', 'cambodgien',
        'laos', 'vientiane', 'laotien', 'myanmar', 'birmanie'
      ],
      'travel_terms': [
        'vol', 'vols', 'compagnie a√©rienne', 'a√©roport',
        'visa', 'passeport', 'fronti√®re', 'douane',
        'h√¥tel', 'h√©bergement', 'booking', 'r√©servation',
        'transport', 'm√©tro', 'bus', 'train', 'taxi',
        'monnaie', 'change', 'euro', 'yen', 'won', 'baht',
        's√©curit√©', 'sant√©', 'vaccin', 'assurance',
        'climat', 'm√©t√©o', 'saison', 'temp√©rature',
        'culture', 'tradition', 'festival', 'f√™te',
        'gastronomie', 'cuisine', 'restaurant', 'nourriture',
        'shopping', 'achat', 'souvenir', 'march√©'
      ],
      'exclusion_terms': [
        'europe', 'am√©rique', 'afrique', 'oc√©anie',
        'croisi√®re', 'yacht', 'luxe', 'h√¥tel 5 √©toiles',
        'golf', 'ski', 'plage carib√©enne', 'm√©diterran√©e'
      ]
    };

    // Syst√®me de scoring de pertinence
    this.scoringWeights = {
      'destination_match': 50,      // Correspondance destination Asie
      'travel_relevance': 30,      // Pertinence voyage
      'french_content': 20,        // Contenu en fran√ßais
      'recent_news': 10,           // Actualit√© r√©cente
      'exclusion_penalty': -100    // P√©nalit√© exclusion
    };
  }

  // Traduction simple anglais -> fran√ßais
  translateToFrench(text) {
    const translations = {
      'japan': 'Japon',
      'tokyo': 'Tokyo',
      'thailand': 'Tha√Ølande',
      'bangkok': 'Bangkok',
      'korea': 'Cor√©e du Sud',
      'seoul': 'S√©oul',
      'vietnam': 'Vietnam',
      'singapore': 'Singapour',
      'philippines': 'Philippines',
      'indonesia': 'Indon√©sie',
      'china': 'Chine',
      'taiwan': 'Ta√Øwan',
      'cambodia': 'Cambodge',
      'laos': 'Laos',
      'myanmar': 'Myanmar',
      'travel': 'voyage',
      'flight': 'vol',
      'hotel': 'h√¥tel',
      'visa': 'visa',
      'safety': 's√©curit√©',
      'news': 'actualit√©',
      'update': 'mise √† jour',
      'alert': 'alerte',
      'deal': 'bon plan',
      'offer': 'offre',
      'promotion': 'promotion',
      'discount': 'r√©duction'
    };

    let translatedText = text.toLowerCase();
    for (const [en, fr] of Object.entries(translations)) {
      translatedText = translatedText.replace(new RegExp(en, 'gi'), fr);
    }
    return translatedText;
  }

  // Analyser la pertinence d'un article
  analyzeRelevance(article) {
    const title = article.title.toLowerCase();
    const description = (article.description || '').toLowerCase();
    const content = title + ' ' + description;

    let score = 0;
    let reasons = [];

    // 1. V√©rifier les destinations Asie
    const destinationMatches = this.asiaKeywords.destinations.filter(keyword => 
      content.includes(keyword)
    );
    if (destinationMatches.length > 0) {
      score += this.scoringWeights.destination_match;
      reasons.push(`Destinations Asie: ${destinationMatches.join(', ')}`);
    }

    // 2. V√©rifier les termes de voyage
    const travelMatches = this.asiaKeywords.travel_terms.filter(keyword => 
      content.includes(keyword)
    );
    if (travelMatches.length > 0) {
      score += this.scoringWeights.travel_relevance;
      reasons.push(`Termes voyage: ${travelMatches.length} correspondances`);
    }

    // 3. V√©rifier le contenu fran√ßais
    const frenchIndicators = ['le ', 'la ', 'les ', 'un ', 'une ', 'des ', 'du ', 'de la '];
    const frenchMatches = frenchIndicators.filter(indicator => 
      content.includes(indicator)
    );
    if (frenchMatches.length > 0) {
      score += this.scoringWeights.french_content;
      reasons.push('Contenu fran√ßais d√©tect√©');
    }

    // 4. V√©rifier l'actualit√© r√©cente (moins de 7 jours)
    const pubDate = new Date(article.pubDate);
    const now = new Date();
    const daysDiff = (now - pubDate) / (1000 * 60 * 60 * 24);
    if (daysDiff <= 7) {
      score += this.scoringWeights.recent_news;
      reasons.push(`Actualit√© r√©cente (${Math.round(daysDiff)} jours)`);
    }

    // 5. V√©rifier les termes d'exclusion
    const exclusionMatches = this.asiaKeywords.exclusion_terms.filter(keyword => 
      content.includes(keyword)
    );
    if (exclusionMatches.length > 0) {
      score += this.scoringWeights.exclusion_penalty;
      reasons.push(`TERMES D'EXCLUSION: ${exclusionMatches.join(', ')}`);
    }

    return {
      score,
      reasons,
      isRelevant: score >= 50, // Seuil de pertinence
      destination: destinationMatches[0] || 'Asie',
      travelType: this.detectTravelType(content)
    };
  }

  // D√©tecter le type de contenu voyage
  detectTravelType(content) {
    if (content.includes('vol') || content.includes('compagnie') || content.includes('a√©roport')) {
      return 'transport';
    } else if (content.includes('visa') || content.includes('passeport') || content.includes('fronti√®re')) {
      return 'formalit√©s';
    } else if (content.includes('h√¥tel') || content.includes('h√©bergement') || content.includes('booking')) {
      return 'h√©bergement';
    } else if (content.includes('s√©curit√©') || content.includes('alerte') || content.includes('sant√©')) {
      return 's√©curit√©';
    } else if (content.includes('deal') || content.includes('offre') || content.includes('promotion')) {
      return 'bon-plan';
    } else {
      return 'actualit√©';
    }
  }

  // R√©cup√©rer et filtrer les articles RSS
  async fetchAndFilterRSS() {
    console.log('üîç R√©cup√©ration et filtrage RSS ultra-intelligent...\n');
    
    const allArticles = [];
    const relevantArticles = [];

    for (const [category, sources] of Object.entries(this.asiaRSSSources)) {
      console.log(`üì° Traitement ${category}...`);
      
      for (const sourceUrl of sources) {
        try {
          const articles = await this.fetchRSSFeed(sourceUrl);
          if (articles) {
            allArticles.push(...articles.map(article => ({
              ...article,
              source: sourceUrl,
              category
            })));
          }
        } catch (error) {
          console.log(`‚ö†Ô∏è Erreur ${sourceUrl}: ${error.message}`);
        }
      }
    }

    console.log(`\nüìä ${allArticles.length} articles r√©cup√©r√©s au total`);

    // Analyser et filtrer chaque article
    for (const article of allArticles) {
      const analysis = this.analyzeRelevance(article);
      
      if (analysis.isRelevant) {
        relevantArticles.push({
          ...article,
          analysis,
          translatedTitle: this.translateToFrench(article.title)
        });
        
        console.log(`‚úÖ Article pertinent trouv√©:`);
        console.log(`   üì∞ ${article.title}`);
        console.log(`   üá´üá∑ ${this.translateToFrench(article.title)}`);
        console.log(`   üìä Score: ${analysis.score}/100`);
        console.log(`   üéØ Raisons: ${analysis.reasons.join(', ')}`);
        console.log(`   üè∑Ô∏è Type: ${analysis.travelType}`);
        console.log(`   üåè Destination: ${analysis.destination}\n`);
      }
    }

    console.log(`üéØ ${relevantArticles.length} articles pertinents trouv√©s sur ${allArticles.length}`);
    
    return relevantArticles;
  }

  // R√©cup√©rer un flux RSS
  async fetchRSSFeed(url) {
    try {
      const response = await axios.get(url, {
        timeout: 15000,
        headers: {
          'User-Agent': 'Mozilla/5.0 (compatible; FlashVoyages-Ultra-Smart-RSS/1.0)'
        }
      });

      if (response.status === 200) {
        const parser = new xml2js.Parser();
        const result = await parser.parseStringPromise(response.data);
        
        let items = [];
        if (result.rss && result.rss.channel && result.rss.channel[0].item) {
          items = result.rss.channel[0].item;
        } else if (result.feed && result.feed.entry) {
          items = result.feed.entry;
        }

        return items.map(item => ({
          title: item.title?.[0] || item.title?._ || 'Sans titre',
          description: item.description?.[0] || item.description?._ || item.summary?.[0] || '',
          link: item.link?.[0] || item.link?._ || '#',
          pubDate: item.pubDate?.[0] || item.published?.[0] || new Date().toISOString()
        }));
      }
    } catch (error) {
      console.error(`Erreur RSS ${url}:`, error.message);
    }
    return null;
  }

  // G√©n√©rer un article FlashVoyages √† partir d'une news pertinente
  generateFlashVoyagesArticle(news) {
    const analysis = news.analysis;
    const destination = analysis.destination;
    const travelType = analysis.travelType;
    
    // Titre en fran√ßais
    const frenchTitle = `üåè ${destination.charAt(0).toUpperCase() + destination.slice(1)} : ${news.translatedTitle}`;
    
    // Contenu structur√© selon le type
    let content = '';
    
    switch (travelType) {
      case 'transport':
        content = this.generateTransportContent(news, destination);
        break;
      case 'formalit√©s':
        content = this.generateFormalitiesContent(news, destination);
        break;
      case 's√©curit√©':
        content = this.generateSecurityContent(news, destination);
        break;
      case 'bon-plan':
        content = this.generateDealContent(news, destination);
        break;
      default:
        content = this.generateGeneralContent(news, destination);
    }

    return {
      title: frenchTitle,
      content,
      type: travelType,
      destination,
      category: this.getCategoryFromDestination(destination),
      tags: this.generateTags(destination, travelType),
      source: news.source,
      originalLink: news.link,
      relevanceScore: analysis.score
    };
  }

  generateTransportContent(news, destination) {
    return `
      <h2>‚úàÔ∏è ${destination} - Actualit√© transport</h2>
      <p><em>üìÖ Derni√®re mise √† jour : ${new Date().toLocaleDateString('fr-FR')}</em></p>
      
      <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0;">
        <h3>üöÄ FlashVoyages vous informe</h3>
        <p><strong>${news.translatedTitle}</strong></p>
        <p>${news.description}</p>
      </div>
      
      <h3>‚úàÔ∏è Impact sur vos voyages</h3>
      <ul>
        <li>Informations importantes pour vos d√©placements vers ${destination}</li>
        <li>Conseils FlashVoyages pour optimiser vos trajets</li>
        <li>Mise √† jour des conditions de transport</li>
      </ul>
      
      <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
        <h4>üí° Conseil FlashVoyages</h4>
        <p>Restez inform√© des derni√®res actualit√©s transport avec FlashVoyages. Nous surveillons en permanence les d√©veloppements qui peuvent affecter vos voyages vers ${destination}.</p>
      </div>
    `;
  }

  generateFormalitiesContent(news, destination) {
    return `
      <h2>üìã ${destination} - Formalit√©s de voyage</h2>
      <p><em>üìÖ Derni√®re mise √† jour : ${new Date().toLocaleDateString('fr-FR')}</em></p>
      
      <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 20px 0;">
        <h3>üöÄ FlashVoyages vous informe</h3>
        <p><strong>${news.translatedTitle}</strong></p>
        <p>${news.description}</p>
      </div>
      
      <h3>üìã Formalit√©s importantes</h3>
      <ul>
        <li>Informations cruciales pour vos formalit√©s vers ${destination}</li>
        <li>Conseils FlashVoyages pour bien pr√©parer vos documents</li>
        <li>Mise √† jour des exigences d'entr√©e</li>
      </ul>
      
      <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
        <h4>üí° Conseil FlashVoyages</h4>
        <p>Les formalit√©s peuvent changer rapidement. FlashVoyages vous tient inform√© des derni√®res √©volutions pour ${destination}.</p>
      </div>
    `;
  }

  generateSecurityContent(news, destination) {
    return `
      <h2>üõ°Ô∏è ${destination} - S√©curit√© voyage</h2>
      <p><em>üìÖ Derni√®re mise √† jour : ${new Date().toLocaleDateString('fr-FR')}</em></p>
      
      <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin: 20px 0;">
        <h3>üö® FlashVoyages vous alerte</h3>
        <p><strong>${news.translatedTitle}</strong></p>
        <p>${news.description}</p>
      </div>
      
      <h3>üõ°Ô∏è Informations s√©curit√©</h3>
      <ul>
        <li>Informations importantes pour votre s√©curit√© en ${destination}</li>
        <li>Conseils FlashVoyages pour voyager en toute s√©curit√©</li>
        <li>Mise √† jour des conditions de s√©curit√©</li>
      </ul>
      
      <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
        <h4>üí° Conseil FlashVoyages</h4>
        <p>La s√©curit√© est notre priorit√©. FlashVoyages vous informe des derni√®res alertes pour ${destination}.</p>
      </div>
    `;
  }

  generateDealContent(news, destination) {
    return `
      <h2>üí∞ ${destination} - Bon plan voyage</h2>
      <p><em>üìÖ Derni√®re mise √† jour : ${new Date().toLocaleDateString('fr-FR')}</em></p>
      
      <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 20px 0;">
        <h3>üéØ FlashVoyages vous fait √©conomiser</h3>
        <p><strong>${news.translatedTitle}</strong></p>
        <p>${news.description}</p>
      </div>
      
      <h3>üí∞ Opportunit√© √† saisir</h3>
      <ul>
        <li>Offre sp√©ciale pour ${destination}</li>
        <li>Conseils FlashVoyages pour profiter de cette opportunit√©</li>
        <li>Conditions et validit√© de l'offre</li>
      </ul>
      
      <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
        <h4>üí° Conseil FlashVoyages</h4>
        <p>Ne ratez pas cette opportunit√© ! FlashVoyages vous aide √† identifier les meilleures offres pour ${destination}.</p>
      </div>
    `;
  }

  generateGeneralContent(news, destination) {
    return `
      <h2>üì∞ ${destination} - Actualit√© voyage</h2>
      <p><em>üìÖ Derni√®re mise √† jour : ${new Date().toLocaleDateString('fr-FR')}</em></p>
      
      <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 20px 0;">
        <h3>üöÄ FlashVoyages vous informe</h3>
        <p><strong>${news.translatedTitle}</strong></p>
        <p>${news.description}</p>
      </div>
      
      <h3>üìä D√©tails de l'actualit√©</h3>
      <ul>
        <li><strong>Source :</strong> ${news.source}</li>
        <li><strong>Date :</strong> ${new Date(news.pubDate).toLocaleDateString('fr-FR')}</li>
        <li><strong>Destination :</strong> ${destination}</li>
        <li><strong>Pertinence :</strong> ${news.analysis.score}/100</li>
      </ul>
      
      <h3>üí° Impact pour les voyageurs</h3>
      <ul>
        <li>Informations importantes pour votre voyage en ${destination}</li>
        <li>Conseils FlashVoyages pour bien pr√©parer votre s√©jour</li>
        <li>Mise √† jour des conditions de voyage</li>
      </ul>
      
      <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
        <h4>üí° Conseil FlashVoyages</h4>
        <p>Restez inform√© des derni√®res actualit√©s voyage avec FlashVoyages. Nous surveillons en permanence les d√©veloppements qui peuvent affecter votre voyage en ${destination}.</p>
      </div>
    `;
  }

  getCategoryFromDestination(destination) {
    const categoryMap = {
      'japon': 'Japon',
      'tokyo': 'Japon',
      'thailande': 'Tha√Ølande',
      'bangkok': 'Tha√Ølande',
      'cor√©e': 'Cor√©e du Sud',
      's√©oul': 'Cor√©e du Sud',
      'vietnam': 'Vietnam',
      'singapour': 'Singapour',
      'philippines': 'Philippines',
      'indon√©sie': 'Indon√©sie',
      'chine': 'Chine',
      'ta√Øwan': 'Ta√Øwan',
      'cambodge': 'Cambodge',
      'laos': 'Laos',
      'myanmar': 'Myanmar'
    };
    
    return categoryMap[destination.toLowerCase()] || 'Asie';
  }

  generateTags(destination, travelType) {
    const baseTags = ['actualite', 'voyage', destination.toLowerCase()];
    
    const typeTags = {
      'transport': ['vol', 'transport'],
      'formalit√©s': ['visa', 'formalites'],
      's√©curit√©': ['securite', 'alerte'],
      'bon-plan': ['bon-plan', 'offre'],
      'actualit√©': ['news', 'info']
    };
    
    return [...baseTags, ...(typeTags[travelType] || [])];
  }
}

// Test du syst√®me
async function testUltraSmartRSSFilter() {
  console.log('üß™ Test du filtre RSS ultra-intelligent FlashVoyages\n');
  
  const filter = new UltraSmartRSSFilter();
  
  try {
    // R√©cup√©rer et filtrer les articles
    const relevantArticles = await filter.fetchAndFilterRSS();
    
    if (relevantArticles.length > 0) {
      console.log(`\nüéØ ${relevantArticles.length} articles pertinents trouv√©s !`);
      
      // G√©n√©rer un article test
      const testArticle = filter.generateFlashVoyagesArticle(relevantArticles[0]);
      
      console.log('\nüìù Article FlashVoyages g√©n√©r√© :');
      console.log(`üì∞ Titre: ${testArticle.title}`);
      console.log(`üè∑Ô∏è Type: ${testArticle.type}`);
      console.log(`üåè Destination: ${testArticle.destination}`);
      console.log(`üìÇ Cat√©gorie: ${testArticle.category}`);
      console.log(`üè∑Ô∏è Tags: ${testArticle.tags.join(', ')}`);
      console.log(`üìä Score pertinence: ${testArticle.relevanceScore}/100`);
      
      return {
        success: true,
        articlesFound: relevantArticles.length,
        testArticle
      };
    } else {
      console.log('\n‚ö†Ô∏è Aucun article pertinent trouv√©');
      return { success: false, articlesFound: 0 };
    }
    
  } catch (error) {
    console.error('‚ùå Erreur:', error.message);
    return { success: false, error: error.message };
  }
}

// Ex√©cuter le test
if (import.meta.url === `file://${process.argv[1]}`) {
  testUltraSmartRSSFilter().then(result => {
    if (result.success) {
      console.log('\n‚úÖ Test r√©ussi !');
      console.log('üåè Le filtre RSS ultra-intelligent fonctionne parfaitement');
      console.log('üá´üá∑ Contenu en fran√ßais et pertinent pour l\'Asie');
      console.log('üéØ Scoring intelligent et filtrage efficace');
    } else {
      console.log('\n‚ùå Test √©chou√©');
      console.log('üîç V√©rifiez les logs pour plus de d√©tails');
    }
  });
}

export default UltraSmartRSSFilter;

