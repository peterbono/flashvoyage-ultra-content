name: 🏠 Nomade Hub Asie - Publication Automatique

on:
  schedule:
    # Exécuter tous les jours à 6h00 UTC (8h00 heure française)
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Mode test (simulation)'
        required: false
        default: 'false'
        type: boolean

jobs:
  nomade-hub:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout du code
      uses: actions/checkout@v4
      
    - name: 📦 Configuration Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: 🧹 Nettoyage du cache npm
      run: npm cache clean --force
      
    - name: 📚 Installation des dépendances
      run: |
        npm install
        echo "✅ Dépendances installées"
        
    - name: 🔧 Configuration des variables d'environnement
      run: |
        echo "WORDPRESS_URL=${{ secrets.WORDPRESS_URL }}" >> .env
        echo "WORDPRESS_USERNAME=${{ secrets.WORDPRESS_USERNAME }}" >> .env
        echo "WORDPRESS_APP_PASSWORD=${{ secrets.WORDPRESS_APP_PASSWORD }}" >> .env
        echo "PEXELS_API_KEY=${{ secrets.PEXELS_API_KEY }}" >> .env
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
        echo "✅ Variables d'environnement configurées"
        
    - name: 🧪 Test du système nomade
      run: |
        echo "🧪 Test du système nomade..."
        node test-nomade-system.js
        echo "✅ Tests terminés"
        
    - name: 🏠 Génération du hub nomade
      if: ${{ !inputs.test_mode }}
      run: |
        echo "🏠 Génération du hub nomade..."
        node nomade-hub-main.js
        echo "✅ Hub nomade généré"
        
    - name: 🧪 Test du hub nomade (mode simulation)
      if: ${{ inputs.test_mode }}
      run: |
        echo "🧪 Test du hub nomade en mode simulation..."
        node nomade-hub-main.js
        echo "✅ Test terminé"
        
    - name: 📊 Rapport de génération
      if: always()
      run: |
        echo "📊 RAPPORT DE GÉNÉRATION DU HUB NOMADE"
        echo "======================================"
        echo "Date: $(date)"
        echo "Mode: ${{ inputs.test_mode && 'Test' || 'Production' }}"
        echo "Status: ${{ job.status }}"
        echo "======================================"
